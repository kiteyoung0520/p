<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç°¡å ±é­”æ³•å¸« Pro - è‡ªå‹•æ’ç‰ˆç”¢ç”Ÿå™¨</title>

  <!-- è¼‰å…¥ Tailwind CSS (CDNç‰ˆ) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- è¼‰å…¥ React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- è¼‰å…¥ Babel ç·¨è­¯å™¨ (è®“ç€è¦½å™¨èƒ½ç›´æ¥çœ‹æ‡‚ JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- è¼‰å…¥å¤–éƒ¨åŒ¯å‡ºå·¥å…· (Google ç™»å…¥ã€æˆªåœ–ã€ç°¡å ±ç”Ÿæˆ) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

  <style>
    /* è‡ªè¨‚æ²è»¸æ¨£å¼ */
    .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="bg-slate-100 text-slate-900 font-sans overflow-hidden">
  
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- SVG åœ–ç¤ºå…ƒä»¶åº« ---
    const SvgIcon = ({ d, className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{__html: d}}></svg>
    );
    const Settings = (p) => <SvgIcon className={p.className} d='<circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>'/>;
    const Plus = (p) => <SvgIcon className={p.className} d='<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>'/>;
    const Trash2 = (p) => <SvgIcon className={p.className} d='<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line>'/>;
    const ChevronLeft = (p) => <SvgIcon className={p.className} d='<polyline points="15 18 9 12 15 6"></polyline>'/>;
    const ChevronRight = (p) => <SvgIcon className={p.className} d='<polyline points="9 18 15 12 9 6"></polyline>'/>;
    const Play = (p) => <SvgIcon className={p.className} d='<polygon points="5 3 19 12 5 21 5 3"></polygon>'/>;
    const Layout = (p) => <SvgIcon className={p.className} d='<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line>'/>;
    const Palette = (p) => <SvgIcon className={p.className} d='<circle cx="13.5" cy="6.5" r=".5"></circle><circle cx="17.5" cy="10.5" r=".5"></circle><circle cx="8.5" cy="7.5" r=".5"></circle><circle cx="6.5" cy="12.5" r=".5"></circle><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"></path>'/>;
    const Type = (p) => <SvgIcon className={p.className} d='<polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line>'/>;
    const Maximize2 = (p) => <SvgIcon className={p.className} d='<polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line>'/>;
    const X = (p) => <SvgIcon className={p.className} d='<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>'/>;
    const FileText = (p) => <SvgIcon className={p.className} d='<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline>'/>;
    const BookOpen = (p) => <SvgIcon className={p.className} d='<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>'/>;
    const Download = (p) => <SvgIcon className={p.className} d='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>'/>;
    const CloudUpload = (p) => <SvgIcon className={p.className} d='<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path><polyline points="16 16 12 12 8 16"></polyline><line x1="12" y1="12" x2="12" y2="21"></line>'/>;
    const Loader2 = (p) => <SvgIcon className={p.className} d='<path d="M21 12a9 9 0 1 1-6.219-8.56"></path>'/>;
    const PanelLeftClose = (p) => <SvgIcon className={p.className} d='<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line><polyline points="14 15 11 12 14 9"></polyline>'/>;
    const PanelLeftOpen = (p) => <SvgIcon className={p.className} d='<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line><polyline points="11 9 14 12 11 15"></polyline>'/>;

    // --- è¨­å®šæª” (Themes & Palettes) ---
    const PALETTES = [
      { id: 'corporate', name: 'ä¼æ¥­è—ç°', bg: 'bg-slate-50', primary: 'bg-blue-800', text: 'text-slate-800', accent: 'bg-cyan-500', decors: ['bg-blue-900', 'bg-blue-300', 'bg-slate-200'] },
      { id: 'earthy', name: 'æº«é¦¨å¤§åœ°', bg: 'bg-orange-50', primary: 'bg-amber-700', text: 'text-stone-800', accent: 'bg-rose-400', decors: ['bg-orange-200', 'bg-rose-200', 'bg-amber-100'] },
      { id: 'pastel', name: 'æ•™è‚²ç²‰å½©', bg: 'bg-green-50', primary: 'bg-emerald-600', text: 'text-slate-700', accent: 'bg-yellow-400', decors: ['bg-green-200', 'bg-teal-100', 'bg-yellow-200'] },
      { id: 'neon', name: 'å¨›æ¨‚éœ“è™¹', bg: 'bg-zinc-950', primary: 'bg-fuchsia-600', text: 'text-white', accent: 'bg-lime-400', decors: ['bg-purple-800', 'bg-pink-600', 'bg-cyan-400'] },
      { id: 'forest', name: 'æ£®æ—ç§˜å¢ƒ', bg: 'bg-stone-50', primary: 'bg-emerald-800', text: 'text-stone-800', accent: 'bg-orange-500', decors: ['bg-emerald-900', 'bg-emerald-300', 'bg-stone-200'] },
      { id: 'ocean', name: 'æ·±æµ·æ¹›è—', bg: 'bg-slate-900', primary: 'bg-blue-500', text: 'text-slate-50', accent: 'bg-teal-300', decors: ['bg-blue-800', 'bg-cyan-600', 'bg-slate-800'] },
      { id: 'sunset', name: 'æ—¥è½æ™šéœ', bg: 'bg-orange-50', primary: 'bg-rose-700', text: 'text-orange-950', accent: 'bg-amber-500', decors: ['bg-orange-300', 'bg-rose-300', 'bg-yellow-200'] },
      { id: 'dark_mode', name: 'æ¥µè‡´æš—é»‘', bg: 'bg-neutral-950', primary: 'bg-neutral-700', text: 'text-neutral-50', accent: 'bg-neutral-300', decors: ['bg-neutral-800', 'bg-neutral-600', 'bg-neutral-900'] },
      { id: 'lavender', name: 'è–°è¡£è‰ç´«', bg: 'bg-purple-50', primary: 'bg-violet-700', text: 'text-purple-950', accent: 'bg-pink-500', decors: ['bg-purple-300', 'bg-violet-300', 'bg-pink-200'] },
      { id: 'vintage', name: 'å¾©å¤åº•ç‰‡', bg: 'bg-amber-50', primary: 'bg-teal-800', text: 'text-stone-800', accent: 'bg-orange-600', decors: ['bg-stone-300', 'bg-teal-600', 'bg-amber-200'] },
      { id: 'vibrant', name: 'æ´»åŠ›æ™®æ™®', bg: 'bg-yellow-300', primary: 'bg-black', text: 'text-black', accent: 'bg-red-600', decors: ['bg-blue-600', 'bg-yellow-400', 'bg-red-400'] },
    ];

    const THEMES = [
      { id: 'minimalist', name: '1. æ¥µç°¡ç„¡å° (ç·šæ¢èˆ‡ç•™ç™½)' },
      { id: 'rounded', name: '2. æº«æ½¤è¦ªå’Œ (åœ“è§’èˆ‡åŒ…å®¹)' },
      { id: 'cyber', name: '3. ç§‘æŠ€éŠ³åˆ© (ç›´è§’èˆ‡åˆ‡å‰²)' },
      { id: 'dynamic', name: '4. å‹•æ„Ÿæ–œåˆ‡ (é€Ÿåº¦èˆ‡çªç ´)' },
      { id: 'hexagon', name: '5. å…­è§’ç¶²è·¯ (çµæ§‹èˆ‡é€£çµ)' },
      { id: 'elegant', name: '6. å„ªé›…ç²¾å“ (è±æ ¼èˆ‡å°ç¨±)' },
      { id: 'bauhaus', name: '7. åŒ…æµ©æ–¯ (æ¥µè‡´ç´”ç²¹)' },
      { id: 'layered', name: '8. æ¯›ç»ç’ƒé€è¦– (æ·±åº¦èˆ‡ç©ºé–“)' },
      { id: 'memphis', name: '9. å¾©å¤å­Ÿè²æ–¯ (æ´»æ½‘èˆ‡è·³èº)' },
      { id: 'spotlight', name: '10. ç„¦é»åŒ¯èš (èˆå°èˆ‡æ¬Šå¨)' },
    ];

    const SCENARIOS = [
      {
        id: 'elevator', name: 'ğŸš€ æ¥µé€Ÿé›»æ¢¯ (èªªæœ)',
        slides: [
          { layout: 'cover', title: 'æ¥µé€Ÿèªªæœææ¡ˆ', content: 'ï¼ˆå‰¯æ¨™é¡Œ / æ¼”è¬›è€…ï¼‰' },
          { layout: 'title_only', title: 'ç›´æ“Šç—›é»', content: 'ï¼ˆè«‹å¯«å‡ºä¸€å¥éœ‡æ’¼äººå¿ƒçš„ç—›é»å•å¥ï¼‰\nä¾‹å¦‚ï¼šä½ é‚„åœ¨ç”¨äººåŠ›åšç„¡æ•ˆçš„é‡è¤‡å‹å‹•å—ï¼Ÿ' },
          { layout: 'split_column', title: 'è§£æ±ºæ–¹æ¡ˆå°æ¯”', content: 'å‚³çµ±è§£æ³•\n- è€—æ™‚è²»åŠ›\n- æˆæœ¬é«˜æ˜‚\n- å®¹æ˜“å‡ºéŒ¯\n|\næˆ‘å€‘çš„é¡›è¦†æ€§è§£æ³•\n- å…¨è‡ªå‹•åŒ–\n- ç¯€çœ 80% æˆæœ¬\n- é›¶èª¤å·®' },
          { layout: 'title_only', title: 'ç¾åœ¨å°±é–‹å§‹æ”¹è®Šï¼', content: 'ï¼ˆå¼·çƒˆè¡Œå‹•å‘¼ç±² Call to Actionï¼‰\nè«‹ç«‹åˆ»è¯ç¹«æˆ‘å€‘ï¼' }
        ]
      }
    ];

    // ==========================================
    // Core Utilities (æ¶æ§‹ç´šåŸç”Ÿè§£æå™¨)
    // ==========================================
    
    // å–å¾—å¯¦éš›é¡è‰²çš„ Hex ç¢¼ (è¼”åŠ© PPTX)
    const rgbToHex = (rgb) => {
      const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
      if (!match) return '000000';
      const hex = (x) => ("0" + parseInt(x).toString(16)).slice(-2);
      return hex(match[1]) + hex(match[2]) + hex(match[3]);
    };

    // å°‡åŒ…å«ç´”æ–‡å­—è½‰æ›ç‚º PPTX åŸç”Ÿç‰©ä»¶ (ç§»é™¤äº†è¶…é€£çµé‚è¼¯ï¼Œå°ˆæ³¨æ–¼æ¢åˆ—è§£æ)
    const parsePptxText = (rawText, defaultColor, isBold, baseFontSize) => {
      if (!rawText) return [{ text: ' ', options: { fontSize: baseFontSize } }];
      const lines = rawText.split('\n');
      let block = [];
      
      lines.forEach((line) => {
        const isBullet = line.trim().startsWith('- ');
        const cleanLine = isBullet ? line.trim().substring(2) : line;
        
        block.push({
            text: cleanLine || ' ',
            options: {
                color: defaultColor,
                bold: isBold,
                fontSize: baseFontSize,
                bullet: isBullet ? true : false,
                breakLine: true
            }
        });
      });
      return block;
    };

    const getCalculatedLayout = (slide, index) => {
      if (slide.layout && slide.layout !== 'auto') return slide.layout;
      if (index === 0) return 'cover';
      const safeContent = slide.content || '';
      if (safeContent.includes('|')) return 'split_column';
      const textLen = safeContent.trim().length;
      if (textLen < 30 && !safeContent.includes('- ') && !safeContent.includes('\n\n')) return 'title_only';
      return 'standard_list';
    };

    const renderGeometricBackground = (theme, palette, layoutType, index) => {
      const isCover = layoutType === 'cover';
      const isEven = index % 2 === 0;
      switch (theme) {
        case 'minimalist': return <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">{isCover ? <div className={`absolute top-[45%] left-1/2 transform -translate-x-1/2 w-32 h-[1px] ${palette.primary}`}></div> : <><div className={`absolute top-0 left-0 w-full h-[3px] ${palette.primary} opacity-80`}></div><div className={`absolute bottom-12 ${isEven ? 'right-20' : 'left-20'} w-12 h-[1px] ${palette.accent}`}></div></>}</div>;
        case 'rounded': return <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">{isCover ? <><div className={`absolute -top-20 -left-20 w-96 h-96 rounded-[80px] ${palette.primary} opacity-10 rotate-12`}></div><div className={`absolute -bottom-10 -right-10 w-64 h-64 rounded-[60px] ${palette.decors[1]} opacity-30 -rotate-6`}></div></> : <><div className={`absolute top-10 ${isEven ? '-left-10' : '-right-10'} w-40 h-20 rounded-full ${palette.decors[0]} opacity-20`}></div><div className={`absolute bottom-[-20px] ${isEven ? 'right-10' : 'left-10'} w-32 h-32 rounded-[40px] ${palette.accent} opacity-10 rotate-45`}></div></>}</div>;
        case 'cyber': return <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">{isCover ? <><div className={`absolute top-0 right-0 w-1/2 h-full ${palette.primary} opacity-90`} style={{ clipPath: 'polygon(100% 0, 0 0, 100% 100%)' }}></div><div className={`absolute bottom-0 left-0 w-1/3 h-1/2 ${palette.accent} opacity-20`} style={{ clipPath: 'polygon(0 100%, 0 0, 100% 100%)' }}></div></> : <><div className={`absolute top-0 right-0 w-64 h-64 ${palette.decors[0]} opacity-30`} style={{ clipPath: 'polygon(100% 0, 0 0, 100% 100%)' }}></div><div className={`absolute bottom-10 ${isEven ? 'left-10' : 'right-10'} w-0 h-0 border-l-[30px] border-l-transparent border-b-[30px] border-b-${palette.accent.replace('bg-','')} opacity-80`}></div></>}</div>;
        case 'dynamic': return <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">{isCover ? <><div className={`absolute top-0 left-1/4 w-32 h-full ${palette.primary} opacity-20 skew-x-[-20deg]`}></div><div className={`absolute top-0 right-1/4 w-64 h-full ${palette.decors[1]} opacity-80 skew-x-[-20deg] mix-blend-multiply`}></div><div className={`absolute bottom-20 left-10 w-48 h-4 ${palette.accent} skew-x-[-20deg]`}></div></> : <><div className={`absolute top-0 ${isEven ? 'left-10' : 'right-10'} w-12 h-full ${palette.decors[0]} opacity-10 skew-x-[-20deg]`}></div><div className={`absolute bottom-10 ${isEven ? 'right-20' : 'left-20'} w-24 h-6 ${palette.accent} opacity-40 skew-x-[-20deg]`}></div></>}</div>;
        case 'hexagon': const hexClip = 'polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)'; return <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">{isCover ? <><div className={`absolute -top-32 -right-16 w-96 h-96 ${palette.primary} opacity-20`} style={{ clipPath: hexClip }}></div><div className={`absolute bottom-10 left-10 w-32 h-32 ${palette.accent} opacity-60`} style={{ clipPath: hexClip }}></div><div className={`absolute top-1/2 left-1/3 w-16 h-16 ${palette.decors[1]} opacity-40`} style={{ clipPath: hexClip }}></div></> : <><div className={`absolute top-[-20px] ${isEven ? '-left-10' : '-right-10'} w-48 h-48 ${palette.decors[0]} opacity-10`} style={{ clipPath: hexClip }}></div><div className={`absolute bottom-12 ${isEven ? 'right-12' : 'left-12'} w-12 h-12 ${palette.accent} opacity-40`} style={{ clipPath: hexClip }}></div></>}</div>;
        case 'elegant': return <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">{isCover ? <><div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[30rem] h-[30rem] border-[1px] border-current opacity-10 rotate-45"></div><div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[32rem] h-[32rem] border-[1px] border-current opacity-5 rotate-45"></div><div className={`absolute top-10 left-1/2 transform -translate-x-1/2 w-4 h-4 ${palette.accent} rotate-45`}></div></> : <><div className={`absolute top-0 right-0 w-32 h-32 border-b-[1px] border-l-[1px] border-current opacity-10`}></div><div className={`absolute bottom-10 ${isEven ? 'right-10' : 'left-10'} w-8 h-8 border-[2px] border-${palette.accent.replace('bg-','')} rotate-45 opacity-60`}></div></>}</div>;
        case 'bauhaus': return <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">{isCover ? <><div className={`absolute -top-10 -right-10 w-80 h-80 rounded-full ${palette.primary} opacity-90`}></div><div className={`absolute bottom-20 left-20 w-48 h-48 ${palette.decors[1]} opacity-90 mix-blend-multiply`}></div><div className={`absolute top-1/3 left-1/4 w-16 h-16 ${palette.accent} opacity-90`}></div></> : <><div className={`absolute top-0 ${isEven ? 'left-0' : 'right-0'} w-6 h-full ${palette.primary} opacity-80`}></div><div className={`absolute bottom-10 ${isEven ? 'right-20' : 'left-20'} w-12 h-12 rounded-full ${palette.accent} opacity-90`}></div></>}</div>;
        case 'layered': return <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">{isCover ? <><div className={`absolute top-10 right-20 w-96 h-[30rem] ${palette.primary} opacity-[0.08] backdrop-blur-3xl rounded-3xl border border-white/20 shadow-xl`}></div><div className={`absolute -bottom-10 left-10 w-[40rem] h-64 ${palette.decors[1]} opacity-[0.12] backdrop-blur-xl rounded-3xl border border-white/30 shadow-2xl`}></div><div className={`absolute top-1/3 left-1/3 w-48 h-48 ${palette.accent} opacity-20 backdrop-blur-md rounded-2xl`}></div></> : <><div className={`absolute top-20 ${isEven ? '-left-20' : '-right-20'} w-64 h-96 ${palette.primary} opacity-[0.06] backdrop-blur-2xl rounded-3xl border border-white/20`}></div><div className={`absolute bottom-[-10%] ${isEven ? 'right-10' : 'left-10'} w-80 h-32 ${palette.decors[0]} opacity-[0.08] backdrop-blur-xl rounded-2xl`}></div></>}</div>;
        case 'memphis': return <div className="absolute inset-0 overflow-hidden pointer-events-none z-0" style={{ backgroundImage: `radial-gradient(${palette.text === 'text-white' ? '#ffffff22' : '#00000011'} 2px, transparent 2px)`, backgroundSize: '40px 40px' }}>{isCover ? <><div className={`absolute top-20 left-20 w-16 h-16 rounded-t-full ${palette.primary} rotate-45 opacity-80`}></div><div className={`absolute bottom-32 right-32 w-20 h-20 border-[6px] border-${palette.decors[1].replace('bg-','')} rounded-full border-dashed opacity-60 animate-spin-slow`}></div><div className={`absolute top-1/4 right-1/4 w-0 h-0 border-l-[25px] border-l-transparent border-b-[40px] border-b-${palette.accent.replace('bg-','')} rotate-[-15deg]`}></div><div className={`absolute bottom-16 left-1/3 text-6xl text-${palette.decors[0].replace('bg-','')} opacity-40 font-bold`}>+</div></> : <><div className={`absolute top-10 ${isEven ? 'right-20' : 'left-20'} w-10 h-10 rounded-full ${palette.primary} opacity-40`}></div><div className={`absolute bottom-20 ${isEven ? 'left-10' : 'right-10'} w-12 h-12 border-[4px] border-${palette.accent.replace('bg-','')}`}></div><div className={`absolute top-1/2 ${isEven ? 'left-20' : 'right-20'} text-4xl text-${palette.decors[1].replace('bg-','')} opacity-30`}>~</div></>}</div>;
        case 'spotlight': return <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">{isCover ? <div className={`absolute bottom-0 left-1/2 transform -translate-x-1/2 w-[120%] h-[120%] ${palette.primary} opacity-10`} style={{ clipPath: 'polygon(30% 100%, 70% 100%, 55% 0, 45% 0)', background: `linear-gradient(to top, var(--tw-gradient-stops))` }}></div> : <div className={`absolute bottom-0 ${isEven ? 'left-0' : 'right-0'} w-3/4 h-[80%] ${palette.primary} opacity-[0.05]`} style={{ clipPath: isEven ? 'polygon(0 100%, 80% 100%, 20% 0, 0 0)' : 'polygon(20% 100%, 100% 100%, 100% 0, 80% 0)' }}></div>}</div>;
        default: return null;
      }
    };

    // å°‡ç´”æ–‡å­—è½‰ç‚º React å…ƒç´ é¡¯ç¤º
    const formatContentText = (text) => {
      if (!text) return null;
      return text.split('\n').map((line, i) => {
        if (line.trim().startsWith('- ')) return <li key={i} className="ml-6 list-disc mb-3 leading-relaxed break-words">{line.trim().substring(2)}</li>;
        return <p key={i} className="mb-4 leading-relaxed break-words whitespace-pre-wrap">{line}</p>;
      });
    };

    const parseSplitColumn = (content) => {
      const safeContent = content || '';
      const parts = safeContent.split('|');
      const parseSide = (sideText) => {
        const lines = (sideText || '').trim().split('\n');
        return { colTitle: lines[0] || '', colContent: lines.slice(1).join('\n') || '' };
      };
      return { left: parseSide(parts[0]), right: parseSide(parts[1]) };
    };

    // --- ğŸ’ éš±å½¢è¼¸å…¥æ¡†æ›¿æ›æ³•å…ƒä»¶ (Click-to-Edit) ---
    const EditableWrapper = ({ isEditable, editingField, setEditingField, field, value, placeholder, children, className, align="left", onUpdate }) => {
        const textareaRef = useRef(null);

        const adjustHeight = () => {
            if (textareaRef.current) {
                textareaRef.current.style.height = 'auto';
                textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px';
            }
        };

        useEffect(() => {
            if (isEditable && editingField === field) {
                adjustHeight();
                // èšç„¦æ™‚å°‡æ¸¸æ¨™ç§»è‡³æœ€å¾Œ
                textareaRef.current.selectionStart = textareaRef.current.value.length;
                textareaRef.current.selectionEnd = textareaRef.current.value.length;
            }
        }, [editingField, field, isEditable]);

        if (!isEditable) return children;

        if (editingField === field) {
            return (
                <textarea
                    ref={textareaRef}
                    autoFocus
                    value={value}
                    onChange={(e) => { onUpdate(field, e.target.value); adjustHeight(); }}
                    onBlur={() => setEditingField(null)}
                    placeholder={placeholder}
                    className={`${className} bg-white/90 text-slate-900 backdrop-blur-md border border-blue-400/50 rounded-xl outline-none resize-none overflow-hidden block w-full focus:ring-4 focus:ring-blue-400/30 p-4 -m-4 shadow-2xl z-[100]`}
                    rows={1}
                    style={{ minHeight: '3em', textAlign: align === 'center' ? 'center' : 'left' }}
                />
            );
        }

        return (
            <div
                onClick={(e) => { e.stopPropagation(); setEditingField(field); }}
                className="cursor-text hover:outline hover:outline-2 hover:outline-blue-400/50 hover:bg-black/5 rounded-xl transition-all relative group z-40 w-full"
                title="é»æ“Šç·¨è¼¯å…§å®¹"
            >
                <div className="absolute -top-3 -right-2 bg-blue-600 text-white text-[11px] font-bold px-2 py-1 rounded-md opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none shadow-sm z-50 flex items-center gap-1">
                   <Type className="w-3 h-3" /> ç·¨è¼¯
                </div>
                {value ? children : <div className={`${className} opacity-30 px-4 py-2`}>{placeholder}</div>}
            </div>
        );
    };

    const SlideView = ({ slide, index, selectedTheme, selectedPalette, isEditable, onUpdate }) => {
      const layoutType = getCalculatedLayout(slide, index);
      const isEven = index % 2 === 0;
      const isCover = layoutType === 'cover';
      const [editingField, setEditingField] = useState(null);

      const getCoverTitleClass = (theme) => {
        switch (theme) {
          case 'cyber': return 'border-l-8 border-current text-left pl-6';
          case 'bauhaus': return 'border-4 border-current p-8 bg-white/5 backdrop-blur-sm';
          case 'elegant': return 'font-serif tracking-widest';
          case 'dynamic': return 'skew-x-[-10deg] italic';
          default: return '';
        }
      };

      return (
        <div className={`relative w-full h-full flex flex-col ${selectedPalette.bg} ${selectedPalette.text} overflow-hidden transition-all duration-500 group`} style={{ aspectRatio: '16/9' }}>
          {renderGeometricBackground(selectedTheme, selectedPalette, layoutType, index)}
          
          {/* æ‡¸æµ®ç‰ˆé¢åˆ‡æ›å™¨ (åƒ…åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹å‡ºç¾) */}
          {isEditable && (
            <div className="absolute top-4 left-4 z-50 opacity-0 group-hover:opacity-100 transition-opacity bg-white/90 backdrop-blur-sm border border-slate-200 shadow-lg rounded-lg p-2 flex items-center gap-2" onClick={e => e.stopPropagation()}>
              <Layout className="w-4 h-4 text-blue-600" />
              <select
                value={slide.layout || 'auto'}
                onChange={(e) => onUpdate('layout', e.target.value)}
                className="text-sm font-bold bg-transparent text-slate-700 outline-none cursor-pointer"
              >
                <option value="auto">âœ¨ AI è‡ªå‹•æ’ç‰ˆ</option>
                <option value="cover">å°é¢é¦–é </option>
                <option value="title_only">å¤§æ¨™é¡Œ/é‡‘å¥</option>
                <option value="split_column">é›™æ¬„å°æ¯” (ä»¥ | åˆ†éš”)</option>
                <option value="standard_list">æ¨™æº–æ¢åˆ—</option>
              </select>
            </div>
          )}

          <div className="relative z-10 w-full h-full p-12 flex">
            
            {layoutType === 'cover' && (
              <div className="flex flex-col justify-center items-center text-center w-full">
                <div className={`max-w-4xl p-10 z-10 flex flex-col items-center gap-6 w-full ${getCoverTitleClass(selectedTheme)}`}>
                   
                   <EditableWrapper isEditable={isEditable} editingField={editingField} setEditingField={setEditingField} field="title" value={slide.title} placeholder="è¼¸å…¥å°é¢æ¨™é¡Œ..." align="center" onUpdate={onUpdate} className={`text-4xl md:text-6xl font-bold tracking-tight break-keep leading-tight ${selectedTheme === 'memphis' ? 'uppercase' : ''}`}>
                       <h1 className={`ppt-text-layer text-4xl md:text-6xl font-bold tracking-tight break-keep leading-tight ${selectedTheme === 'memphis' ? 'uppercase' : ''}`} data-ppt-val={slide.title} data-ppt-align="center">{slide.title}</h1>
                   </EditableWrapper>
                   
                   <EditableWrapper isEditable={isEditable} editingField={editingField} setEditingField={setEditingField} field="content" value={slide.content} placeholder="è¼¸å…¥å‰¯æ¨™é¡Œæˆ–æ¼”è¬›è€…..." align="center" onUpdate={onUpdate} className="text-xl md:text-2xl font-light opacity-90 leading-relaxed break-words whitespace-pre-wrap">
                       <div className="ppt-text-layer text-xl md:text-2xl font-light opacity-90 leading-relaxed break-words whitespace-pre-wrap" data-ppt-val={slide.content} data-ppt-align="center">{formatContentText(slide.content)}</div>
                   </EditableWrapper>

                   {selectedTheme === 'minimalist' && <div className={`w-32 h-[1px] mt-4 mx-auto ${selectedPalette.accent}`}></div>}
                   {selectedTheme === 'cyber' && <div className={`w-24 h-2 mt-4 ${selectedPalette.accent}`}></div>}
                   {selectedTheme === 'bauhaus' && <div className={`w-16 h-16 rounded-full mt-4 mx-auto ${selectedPalette.accent}`}></div>}
                </div>
              </div>
            )}
            
            {layoutType === 'title_only' && (
              <div className="flex flex-col justify-center items-center text-center w-full h-full z-10 gap-8">
                {selectedTheme === 'elegant' && <div className={`w-4 h-4 rotate-45 border border-current opacity-50 shrink-0`}></div>}
                
                <div className="shrink-0 w-full">
                    <EditableWrapper isEditable={isEditable} editingField={editingField} setEditingField={setEditingField} field="title" value={slide.title} placeholder="è¼¸å…¥é‡‘å¥å¤§æ¨™é¡Œ..." align="center" onUpdate={onUpdate} className="text-4xl md:text-6xl font-bold max-w-5xl mx-auto leading-tight break-keep">
                        <h2 className="ppt-text-layer text-4xl md:text-6xl font-bold max-w-5xl mx-auto leading-tight break-keep" data-ppt-val={slide.title} data-ppt-align="center">{slide.title}</h2>
                    </EditableWrapper>
                </div>
                
                {slide.content && (
                    <div className="shrink-0 w-full">
                        <EditableWrapper isEditable={isEditable} editingField={editingField} setEditingField={setEditingField} field="content" value={slide.content} placeholder="è¼¸å…¥è£œå……æ–‡å­—..." align="center" onUpdate={onUpdate} className="text-xl md:text-3xl opacity-80 max-w-4xl mx-auto font-light leading-relaxed break-words whitespace-pre-wrap">
                            <div className="ppt-text-layer text-xl md:text-3xl opacity-80 max-w-4xl mx-auto font-light leading-relaxed break-words whitespace-pre-wrap" data-ppt-val={slide.content} data-ppt-align="center">{formatContentText(slide.content)}</div>
                        </EditableWrapper>
                    </div>
                )}
              </div>
            )}

            {layoutType === 'split_column' && (() => {
              const splitData = parseSplitColumn(slide.content);
              return (
                <div className="flex flex-col w-full h-full z-10 gap-8">
                  <div className="w-full text-center shrink-0">
                    <EditableWrapper isEditable={isEditable} editingField={editingField} setEditingField={setEditingField} field="title" value={slide.title} placeholder="è¼¸å…¥æ¨™é¡Œ..." align="center" onUpdate={onUpdate} className="text-3xl md:text-4xl font-bold leading-tight break-keep">
                        <h2 className="ppt-text-layer text-3xl md:text-4xl font-bold leading-tight break-keep" data-ppt-val={slide.title} data-ppt-align="center">{slide.title}</h2>
                    </EditableWrapper>
                    {selectedTheme !== 'minimalist' && <div className={`h-1 w-24 mx-auto mt-4 ${selectedPalette.accent}`}></div>}
                  </div>
                  
                  <EditableWrapper isEditable={isEditable} editingField={editingField} setEditingField={setEditingField} field="content" value={slide.content} placeholder="è¼¸å…¥é›™æ¬„å…§å®¹ (ä»¥ | ç¬¦è™Ÿåˆ†éš”å·¦å³æ¬„ä½)..." align="left" onUpdate={onUpdate} className="text-lg w-full font-mono">
                      <div className="flex-1 grid grid-cols-2 gap-6 w-full max-w-5xl mx-auto items-start">
                        <div className={`flex flex-col ${selectedTheme === 'rounded' ? 'rounded-2xl' : 'rounded-lg'} p-6 shadow-inner border border-current/10 bg-current/5 backdrop-blur-sm h-full`}>
                          <h3 className="ppt-text-layer text-xl md:text-2xl font-bold mb-4 pb-3 border-b-2 border-current opacity-80 break-keep leading-tight" data-ppt-val={splitData.left.colTitle}>{splitData.left.colTitle}</h3>
                          <ul className="ppt-text-layer text-lg md:text-xl leading-relaxed text-left flex-1 break-words" data-ppt-val={splitData.left.colContent}>{formatContentText(splitData.left.colContent)}</ul>
                        </div>
                        <div className={`flex flex-col ${selectedTheme === 'rounded' ? 'rounded-2xl' : 'rounded-lg'} p-6 shadow-md border border-current/10 bg-current/10 backdrop-blur-sm h-full`}>
                          <h3 className="ppt-text-layer text-xl md:text-2xl font-bold mb-4 pb-3 border-b-2 border-current break-keep leading-tight" data-ppt-val={splitData.right.colTitle}>{splitData.right.colTitle}</h3>
                          <ul className="ppt-text-layer text-lg md:text-xl leading-relaxed text-left flex-1 font-medium break-words" data-ppt-val={splitData.right.colContent}>{formatContentText(splitData.right.colContent)}</ul>
                        </div>
                      </div>
                  </EditableWrapper>
                </div>
              );
            })()}

            {layoutType === 'standard_list' && (
              <div className={`flex flex-col h-full w-full z-10 gap-8 ${isEven ? 'items-start' : (['rounded','elegant'].includes(selectedTheme) ? 'items-center text-center' : 'items-start')} ${['cyber','bauhaus'].includes(selectedTheme) ? 'ml-10' : ''}`}>
                <div className="w-full shrink-0">
                  <EditableWrapper isEditable={isEditable} editingField={editingField} setEditingField={setEditingField} field="title" value={slide.title} placeholder="è¼¸å…¥æ¨™é¡Œ..." align={isEven || !['rounded','elegant'].includes(selectedTheme) ? 'left' : 'center'} onUpdate={onUpdate} className={`text-3xl md:text-4xl font-bold flex items-center ${isEven || !['rounded','elegant'].includes(selectedTheme) ? 'justify-start' : 'justify-center'} leading-tight break-keep`}>
                      <h2 className={`ppt-text-layer text-3xl md:text-4xl font-bold flex items-center ${isEven || !['rounded','elegant'].includes(selectedTheme) ? 'justify-start' : 'justify-center'} leading-tight break-keep`} data-ppt-val={slide.title} data-ppt-align={isEven || !['rounded','elegant'].includes(selectedTheme) ? 'left' : 'center'}>
                        {selectedTheme === 'hexagon' && <span className={`inline-block w-3 h-5 mr-3 ${selectedPalette.primary}`} style={{clipPath: 'polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)'}}></span>}
                        {selectedTheme === 'bauhaus' && <span className={`inline-block w-5 h-5 mr-3 bg-current`}></span>}
                        {slide.title}
                      </h2>
                  </EditableWrapper>
                  {selectedTheme !== 'minimalist' && <div className={`h-1 w-24 mt-4 ${selectedPalette.accent} ${isEven || !['rounded','elegant'].includes(selectedTheme) ? '' : 'mx-auto'}`}></div>}
                </div>
                
                <div className="flex-1 w-full max-w-4xl">
                   <EditableWrapper isEditable={isEditable} editingField={editingField} setEditingField={setEditingField} field="content" value={slide.content} placeholder="è¼¸å…¥æ¢åˆ—å…§å®¹ (- é–‹é ­)..." align={isEven || !['rounded','elegant'].includes(selectedTheme) ? 'left' : 'center'} onUpdate={onUpdate} className={`text-xl md:text-2xl leading-relaxed whitespace-pre-wrap break-words w-full`}>
                       <div className={`ppt-text-layer text-xl md:text-2xl leading-relaxed w-full whitespace-pre-wrap break-words ${isEven || !['rounded','elegant'].includes(selectedTheme) ? 'text-left' : 'text-center'}`} data-ppt-val={slide.content} data-ppt-align={isEven || !['rounded','elegant'].includes(selectedTheme) ? 'left' : 'center'}>
                         <ul className="inline-block text-left">{formatContentText(slide.content)}</ul>
                       </div>
                   </EditableWrapper>
                </div>
              </div>
            )}
            
          </div>
          {!isCover && <div className="absolute bottom-5 right-6 text-base font-bold opacity-30 z-10">{index + 1}</div>}
        </div>
      );
    };

    function App() {
      const [slides, setSlides] = useState(SCENARIOS[0].slides.map((s, i) => ({ ...s, id: `init-${i}` })));
      const [activeSlideIndex, setActiveSlideIndex] = useState(0);
      const [selectedTheme, setSelectedTheme] = useState(THEMES[0].id);
      const [selectedPalette, setSelectedPalette] = useState(PALETTES[0]);
      
      const [isFullscreen, setIsFullscreen] = useState(false);
      const [isSidebarOpen, setIsSidebarOpen] = useState(true);
      
      const [showImportModal, setShowImportModal] = useState(false);
      const [importText, setImportText] = useState('');
      const [selectedScenarioId, setSelectedScenarioId] = useState('');
      const [isExporting, setIsExporting] = useState(false);

      const activeSlide = slides[activeSlideIndex] || slides[0];

      useEffect(() => {
        const handleKeyDown = (e) => {
          if (!isFullscreen) return;
          if (e.key === 'ArrowRight' || e.key === ' ') setActiveSlideIndex((prev) => Math.min(slides.length - 1, prev + 1));
          else if (e.key === 'ArrowLeft') setActiveSlideIndex((prev) => Math.max(0, prev - 1));
          else if (e.key === 'Escape') setIsFullscreen(false);
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [isFullscreen, slides.length]);

      // =========================================================================
      // ğŸ’ Version B: å®Œç¾æ¶æ§‹ç‰ˆåŸç”ŸåŒ¯å‡º (PptxGenJS + html2canvas æ··åˆæ¸²æŸ“å¼•æ“)
      // =========================================================================
      const handleNativeExport = async (mode = 'download', token = null) => {
        if (!window.PptxGenJS || !window.html2canvas) { alert('è™•ç†å¥—ä»¶ä»åœ¨è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™ç‰‡åˆ»å†è©¦ï¼'); return; }
        setIsExporting(true);

        setTimeout(async () => {
          try {
            const pres = new window.PptxGenJS();
            pres.layout = 'LAYOUT_16x9';

            for (let i = 0; i < slides.length; i++) {
              const slideDiv = document.getElementById(`export-slide-${i}`);
              if (!slideDiv) continue;

              // Step 1: æš«æ™‚éš±è—åŸç”Ÿæ”¯æ´çš„ã€Œæ–‡å­—ã€ï¼Œä¿ç•™ç¾éº—çš„ CSS å¹¾ä½•èƒŒæ™¯
              const textLayers = slideDiv.querySelectorAll('.ppt-text-layer');
              textLayers.forEach(el => el.style.opacity = '0');

              // Step 2: æ“·å–èƒŒæ™¯
              const canvas = await window.html2canvas(slideDiv, { scale: 2, useCORS: true, logging: false });
              const bkgdData = canvas.toDataURL('image/jpeg', 0.8);
              
              // Step 3: æ¢å¾©é¡¯ç¤º
              textLayers.forEach(el => el.style.opacity = '1');

              // Step 4: å‰µå»ºæŠ•å½±ç‰‡ï¼Œä¸¦å°‡æ“·åœ–è¨­ç‚ºä¸å¯ç·¨è¼¯ä¹‹èƒŒæ™¯
              const pptSlide = pres.addSlide();
              pptSlide.background = { data: bkgdData };

              // æº–å‚™è¨ˆç®—åº§æ¨™ï¼š1280px = 10 inches (æ¨™æº– PPTX 16:9 å¯¬åº¦)
              const slideRect = slideDiv.getBoundingClientRect();
              const pxToInches = (px) => px / 128;

              // Step 5: ç–ŠåŠ ã€ŒåŸç”Ÿå¯ç·¨è¼¯æ–‡å­—ã€
              textLayers.forEach(textEl => {
                 const rect = textEl.getBoundingClientRect();
                 const x = pxToInches(rect.left - slideRect.left);
                 const y = pxToInches(rect.top - slideRect.top);
                 const w = pxToInches(rect.width);
                 const h = pxToInches(rect.height);

                 const computedStyle = window.getComputedStyle(textEl);
                 const fontSizePx = parseFloat(computedStyle.fontSize) || 24;
                 const fontSizePt = fontSizePx * 0.75; // px è½‰ pt
                 const isBold = computedStyle.fontWeight >= 600 || computedStyle.fontWeight === 'bold';
                 const fontColor = rgbToHex(computedStyle.color);
                 const align = textEl.getAttribute('data-ppt-align') || 'left';
                 const rawText = textEl.getAttribute('data-ppt-val') || '';

                 // è§£æå‡ºé …ç›®ç¬¦è™Ÿ
                 const textObjects = parsePptxText(rawText, fontColor, isBold, fontSizePt);
                 
                 if (textObjects.length > 0) {
                    pptSlide.addText(textObjects, {
                        x, y, w, h,
                        align: align,
                        valign: 'top',
                        margin: 0,
                        wrap: true
                    });
                 }
              });
            }

            // Step 6: ä¾ç…§æ¨¡å¼åŒ¯å‡º
            const filename = `ç°¡å ±é­”æ³•å¸«_ç”¢å‡º_${new Date().toLocaleDateString()}.pptx`;
            if (mode === 'download') {
               await pres.writeFile({ fileName: filename });
            } else if (mode === 'google' && token) {
               const fileBlob = await pres.write({ outputType: 'blob' });
               const base64Data = await new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onloadend = () => resolve(reader.result.split(',')[1]);
                  reader.onerror = reject;
                  reader.readAsDataURL(fileBlob);
                });
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";
                const metadata = { name: filename, mimeType: 'application/vnd.google-apps.presentation' };
                const multipartRequestBody = delimiter + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' + JSON.stringify(metadata) + delimiter + 'Content-Type: application/vnd.openxmlformats-officedocument.presentationml.presentation\r\n' + 'Content-Transfer-Encoding: base64\r\n\r\n' + base64Data + close_delim;
                
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                  method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'multipart/related; boundary=' + boundary }, body: multipartRequestBody,
                });
                
                if (response.ok) alert('âœ… æˆåŠŸåŒ¯å‡ºï¼è«‹è‡³æ‚¨çš„ Google é›²ç«¯ç¡¬ç¢ŸæŸ¥çœ‹æœ€æ–°çš„åŸç”Ÿ Google ç°¡å ±ã€‚');
                else { const err = await response.json(); alert('âŒ å‚³é€å¤±æ•—: ' + (err.error?.message || 'æœªçŸ¥éŒ¯èª¤')); }
            }
          } catch (err) { 
            console.error(err); alert('è™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message); 
          } finally { 
            setIsExporting(false); 
          }
        }, 800);
      };

      const loginAndExportToGoogle = () => {
        const GOOGLE_CLIENT_ID = '572028686072-5s3oqikq4tha4jrcp06kl1716li2gubl.apps.googleusercontent.com'; 
        if (!window.google) { alert("Google ç™»å…¥å¥—ä»¶è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); return; }
        const client = window.google.accounts.oauth2.initTokenClient({
          client_id: GOOGLE_CLIENT_ID,
          scope: 'https://www.googleapis.com/auth/drive.file', 
          callback: (tokenResponse) => {
            if (tokenResponse && tokenResponse.access_token) { handleNativeExport('google', tokenResponse.access_token); }
          },
        });
        client.requestAccessToken();
      };

      const addSlide = () => { setSlides([...slides, { id: Date.now().toString(), layout: 'auto', title: 'æ–°æ¨™é¡Œ', content: '' }]); setActiveSlideIndex(slides.length); };
      const updateSlide = (id, field, value) => { setSlides(slides.map(s => s.id === id ? { ...s, [field]: value } : s)); };
      
      const removeSlide = (id, indexToRemove) => { 
        if (slides.length <= 1) return;
        const newSlides = slides.filter(s => s.id !== id);
        setSlides(newSlides); 
        if (activeSlideIndex >= newSlides.length) {
            setActiveSlideIndex(newSlides.length - 1);
        } else if (activeSlideIndex > indexToRemove) {
            setActiveSlideIndex(activeSlideIndex - 1);
        }
      };
      
      const applyScenario = (scenarioId) => {
        if (!scenarioId) return;
        const scenario = SCENARIOS.find(s => s.id === scenarioId);
        if (scenario) {
          setSlides(scenario.slides.map((s, idx) => ({ ...s, id: Date.now().toString() + '-' + idx })));
          setActiveSlideIndex(0); setSelectedScenarioId(''); 
        }
      };

      const handleImport = () => {
        if (!importText.trim()) return;
        const slideBlocks = importText.split(/^\s*---\s*$/m);
        const newSlides = slideBlocks.map((block, index) => {
          const lines = block.trim().split('\n');
          return {
            id: Date.now().toString() + '-' + index, layout: 'auto',
            title: lines.length > 0 ? lines[0].trim() : `ç¬¬ ${index + 1} é `,
            content: lines.length > 1 ? lines.slice(1).join('\n').trim() : ''
          };
        }).filter(s => s.title || s.content);

        if (newSlides.length > 0) { setSlides(newSlides); setActiveSlideIndex(0); }
        setShowImportModal(false); setImportText('');
      };

      const handleExportText = () => {
        const textContent = slides.map(s => `${s.title}\n${s.content}`).join('\n---\n');
        const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a'); link.href = url; link.download = 'ç°¡å ±å¤§ç¶±_å°å‡º.txt'; link.click(); URL.revokeObjectURL(url);
      };

      return (
        <div className="h-screen bg-slate-100 flex flex-col font-sans relative overflow-hidden">
          
          {/* èƒŒæ™¯éš±è—åŸç”ŸåŒ¯å‡ºåŸºæº–å€åŸŸ (åš´æ ¼è¨­å®šç‚º 1280x720 ä»¥ç¢ºä¿åº§æ¨™æ›ç®—ç²¾æº–) */}
          <div className="fixed top-[-9999px] left-[-9999px] z-[-1] pointer-events-none">
            {isExporting && slides.map((slide, index) => (
              <div key={`export-${slide.id}`} id={`export-slide-${index}`} className="w-[1280px] h-[720px] relative bg-white overflow-hidden">
                <SlideView slide={slide} index={index} selectedTheme={selectedTheme} selectedPalette={selectedPalette} />
              </div>
            ))}
          </div>

          {/* é ‚éƒ¨æ¨™é¡Œèˆ‡å·¥å…·åˆ— */}
          <header className="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm z-30 shrink-0">
            <div className="flex items-center gap-4">
              <button 
                onClick={() => setIsSidebarOpen(!isSidebarOpen)} 
                className="p-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-colors"
                title={isSidebarOpen ? "æ”¶åˆå´é‚Šæ¬„" : "å±•é–‹å´é‚Šæ¬„"}
              >
                {isSidebarOpen ? <PanelLeftClose className="w-5 h-5" /> : <PanelLeftOpen className="w-5 h-5" />}
              </button>
              <div className="flex items-center gap-2">
                <div className="p-1.5 bg-blue-600 rounded-md"><Layout className="w-5 h-5 text-white" /></div>
                <h1 className="text-lg font-bold text-slate-800 tracking-wide">ç°¡å ±é­”æ³•å¸« Pro</h1>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setShowImportModal(true)} className="px-3 py-1.5 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-md transition-colors" title="å¤§é‡åŒ¯å…¥æ–‡å­—">å¤§ç¶±åŒ¯å…¥</button>
              <button onClick={handleExportText} className="px-3 py-1.5 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-md transition-colors mr-2" title="ä¸‹è¼‰æ–‡å­—å¤§ç¶±">å¤§ç¶±åŒ¯å‡º</button>
              
              <div className="w-px h-6 bg-slate-200 mx-1"></div>
              
              <button onClick={() => handleNativeExport('download')} disabled={isExporting} className="flex items-center gap-2 px-4 py-1.5 bg-white border border-blue-200 text-blue-700 rounded-lg hover:bg-blue-50 transition-colors text-sm font-bold shadow-sm ml-2 disabled:opacity-50">
                {isExporting ? <Loader2 className="w-4 h-4 animate-spin" /> : <Download className="w-4 h-4" />}
                ä¸‹è¼‰ PPTX
              </button>
              <button onClick={loginAndExportToGoogle} disabled={isExporting} className="flex items-center gap-2 px-4 py-1.5 bg-yellow-500 text-yellow-950 rounded-lg hover:bg-yellow-400 transition-colors text-sm font-bold shadow-sm disabled:opacity-50">
                {isExporting ? <Loader2 className="w-4 h-4 animate-spin" /> : <CloudUpload className="w-4 h-4" />}
                Google ç°¡å ±
              </button>
              <button onClick={() => setIsFullscreen(true)} className="flex items-center gap-2 px-5 py-1.5 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors text-sm font-medium shadow-md">
                <Play className="w-4 h-4 fill-current" /> æ’­æ”¾
              </button>
            </div>
          </header>

          {isFullscreen ? (
            <div className="fixed inset-0 z-[100] bg-black flex items-center justify-center">
              <button onClick={() => setIsFullscreen(false)} className="absolute top-6 right-6 p-2 text-white/50 hover:text-white z-50 bg-black/50 rounded-full">
                <X className="w-8 h-8" />
              </button>
              <div className="w-full max-w-screen-2xl max-h-screen aspect-video relative shadow-2xl">
                <SlideView slide={slides[activeSlideIndex]} index={activeSlideIndex} selectedTheme={selectedTheme} selectedPalette={selectedPalette} />
                <div className="absolute bottom-6 left-1/2 transform -translate-x-1/2 flex gap-6 px-6 py-3 bg-black/60 backdrop-blur-md rounded-full text-white z-50 opacity-0 hover:opacity-100 transition-opacity">
                   <button onClick={() => setActiveSlideIndex(Math.max(0, activeSlideIndex - 1))} className="hover:text-cyan-400"><ChevronLeft className="w-8 h-8" /></button>
                   <span className="text-xl font-medium leading-8">{activeSlideIndex + 1} / {slides.length}</span>
                   <button onClick={() => setActiveSlideIndex(Math.min(slides.length - 1, activeSlideIndex + 1))} className="hover:text-cyan-400"><ChevronRight className="w-8 h-8" /></button>
                </div>
              </div>
            </div>
          ) : (
            <div className="flex-1 flex overflow-hidden relative">
              
              {/* å¯æ”¶åˆå·¦å´æ¬„ */}
              <div className={`${isSidebarOpen ? 'w-80' : 'w-0'} transition-all duration-300 ease-in-out bg-white border-r border-slate-200 flex flex-col z-20 shrink-0 overflow-hidden`}>
                <div className="p-6 w-80 overflow-y-auto custom-scrollbar h-full">
                  <div className="mb-6 bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm">
                    <label className="block text-sm font-bold text-slate-800 mb-3 flex items-center gap-2"><BookOpen className="w-4 h-4 text-blue-600" /> å¿«é€Ÿè¼‰å…¥æƒ…å¢ƒæ¨¡æ¿</label>
                    <div className="flex flex-col gap-2">
                      <select value={selectedScenarioId} onChange={(e) => setSelectedScenarioId(e.target.value)} className="w-full text-sm border border-slate-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 bg-white text-slate-700 outline-none">
                        <option value="">-- è«‹é¸æ“‡æ¨¡æ¿ (å°‡è¦†è“‹ç¾æœ‰å…§å®¹) --</option>
                        {SCENARIOS.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                      </select>
                      <button onClick={() => applyScenario(selectedScenarioId)} disabled={!selectedScenarioId} className="w-full py-2 bg-blue-600 text-white text-sm font-medium rounded-lg disabled:opacity-50 hover:bg-blue-700 transition-colors">å¥—ç”¨æ¨¡æ¿</button>
                    </div>
                  </div>

                  <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2"><Settings className="w-4 h-4" /> è¦–è¦ºé¢¨æ ¼è¨­å®š</h3>
                  <div className="mb-6">
                    <label className="block text-xs font-medium text-slate-700 mb-2 flex items-center gap-2"><Layout className="w-3 h-3" /> ç‰ˆå‹é¢¨æ ¼ (Layout Style)</label>
                    <select value={selectedTheme} onChange={(e) => setSelectedTheme(e.target.value)} className="w-full text-sm border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-slate-800 bg-white text-slate-700 shadow-sm outline-none">
                      {THEMES.map(theme => <option key={theme.id} value={theme.id}>{theme.name}</option>)}
                    </select>
                  </div>

                  <div className="mb-2">
                    <label className="block text-xs font-medium text-slate-700 mb-2 flex items-center gap-2"><Palette className="w-3 h-3" /> è‰²ç³»é¸æ“‡ (Color Palette)</label>
                    <select value={selectedPalette.id} onChange={(e) => { const found = PALETTES.find(p => p.id === e.target.value); if (found) setSelectedPalette(found); }} className="w-full text-sm border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-slate-800 bg-white text-slate-700 shadow-sm outline-none">
                      {PALETTES.map(palette => <option key={palette.id} value={palette.id}>{palette.name}</option>)}
                    </select>
                    <div className="mt-3 flex w-full h-6 rounded-lg overflow-hidden shadow-inner border border-slate-200">
                      <div className={`flex-[1.5] ${selectedPalette.bg}`} title="èƒŒæ™¯è‰²"></div>
                      <div className={`flex-[2] ${selectedPalette.primary}`} title="ä¸»è‰²"></div>
                      <div className={`flex-1 ${selectedPalette.accent}`} title="é»ç¶´è‰²"></div>
                      <div className={`flex-1 ${selectedPalette.decors[0]}`} title="è£é£¾è‰²"></div>
                    </div>
                  </div>
                </div>
              </div>

              {/* ä¸­é–“èˆ‡å³å´ä¸»å·¥ä½œå€ï¼šåŒ…å«å¤§åœ–é è¦½ã€ä»¥åŠåº•éƒ¨ç¸®åœ–åˆ— */}
              <div className="flex-1 flex flex-col bg-slate-100 min-w-0">
                
                {/* é è¦½èˆ‡ç•«å¸ƒç·¨è¼¯å€ */}
                <div className="flex-1 p-4 md:p-8 flex flex-col items-center justify-start overflow-y-auto custom-scrollbar relative">
                   
                   {/* é ‚ç«¯æ›é å°è¦½ */}
                   <div className="w-full max-w-5xl flex justify-between items-center mb-4">
                     <span className="text-sm font-bold text-slate-400 bg-white px-3 py-1 rounded-full shadow-sm">é é¢ {activeSlideIndex + 1} / {slides.length}</span>
                     <div className="flex gap-2">
                       <button onClick={() => setActiveSlideIndex(Math.max(0, activeSlideIndex - 1))} disabled={activeSlideIndex === 0} className="p-1.5 bg-white rounded shadow-sm text-slate-500 hover:text-blue-600 disabled:opacity-30 transition-colors"><ChevronLeft className="w-4 h-4" /></button>
                       <button onClick={() => setActiveSlideIndex(Math.min(slides.length - 1, activeSlideIndex + 1))} disabled={activeSlideIndex === slides.length - 1} className="p-1.5 bg-white rounded shadow-sm text-slate-500 hover:text-blue-600 disabled:opacity-30 transition-colors"><ChevronRight className="w-4 h-4" /></button>
                     </div>
                   </div>

                   {/* å¤§å°ºå¯¸ç•«å¸ƒ (å•Ÿç”¨ç›´æ¥é»æ“Šç·¨è¼¯æ¨¡å¼) */}
                   <div className="w-full max-w-5xl aspect-video rounded-xl overflow-hidden shadow-[0_10px_40px_rgba(0,0,0,0.15)] ring-1 ring-slate-200/50 relative bg-white shrink-0 transition-all duration-300">
                      <SlideView 
                         slide={activeSlide} 
                         index={activeSlideIndex} 
                         selectedTheme={selectedTheme} 
                         selectedPalette={selectedPalette} 
                         isEditable={true}
                         onUpdate={(field, val) => updateSlide(activeSlide.id, field, val)}
                      />
                   </div>

                </div>
                
                {/* åº•éƒ¨æŠ•å½±ç‰‡ç®¡ç†åˆ— (Thumbnail Strip) */}
                <div className="h-40 bg-white border-t border-slate-200 shrink-0 flex flex-col shadow-[0_-4px_10px_rgba(0,0,0,0.02)] z-20">
                   <div className="px-4 py-2 flex justify-between items-center text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-50">
                     <span>æ‰€æœ‰é é¢ ({slides.length})</span>
                     <span>é»æ“Šé è¦½æˆ–æ‹–æ›³</span>
                   </div>
                   <div className="flex-1 overflow-x-auto flex items-center gap-4 px-4 custom-scrollbar pb-2">
                      {slides.map((slide, idx) => (
                        <div 
                          key={slide.id} 
                          onClick={() => setActiveSlideIndex(idx)} 
                          className={`relative h-24 aspect-video rounded-lg cursor-pointer shrink-0 group transition-all duration-200 ${activeSlideIndex === idx ? 'ring-2 ring-blue-500 ring-offset-2 scale-105 shadow-md z-10' : 'ring-1 ring-slate-200 hover:ring-slate-300 hover:scale-[1.02] opacity-70 hover:opacity-100'}`}
                        >
                          {/* ç¸®åœ–é è¦½ */}
                          <div className={`w-full h-full rounded-lg overflow-hidden ${selectedPalette.bg} relative`}>
                            <div className="absolute inset-0 scale-[0.2] origin-top-left w-[500%] h-[500%] pointer-events-none">
                               <SlideView slide={slide} index={idx} selectedTheme={selectedTheme} selectedPalette={selectedPalette} />
                            </div>
                          </div>
                          
                          {/* é ç¢¼æ¨™ç±¤ */}
                          <div className={`absolute -bottom-2 left-1/2 transform -translate-x-1/2 text-[10px] font-bold px-2 py-0.5 rounded-full ${activeSlideIndex === idx ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-600 shadow-sm'}`}>
                            {idx + 1}
                          </div>

                          {/* åˆªé™¤æŒ‰éˆ• (Hover é¡¯ç¤º) */}
                          <button 
                            onClick={(e) => { e.stopPropagation(); removeSlide(slide.id, idx); }} 
                            className="absolute -top-2 -right-2 bg-red-100 text-red-600 p-1.5 rounded-full opacity-0 group-hover:opacity-100 hover:bg-red-500 hover:text-white transition-all shadow-sm"
                            title="åˆªé™¤é é¢"
                            disabled={slides.length === 1}
                          >
                            <X className="w-3 h-3" />
                          </button>
                        </div>
                      ))}

                      {/* æ–°å¢é é¢æŒ‰éˆ• */}
                      <button 
                        onClick={addSlide} 
                        className="h-24 aspect-video rounded-lg border-2 border-dashed border-slate-300 hover:border-blue-500 hover:bg-blue-50 flex flex-col items-center justify-center text-slate-400 hover:text-blue-600 transition-colors shrink-0 group ml-2"
                      >
                        <Plus className="w-6 h-6 mb-1 group-hover:scale-110 transition-transform" />
                        <span className="text-xs font-bold">æ–°å¢ä¸€é </span>
                      </button>
                   </div>
                </div>

              </div>
            </div>
          )}

          {/* åŒ¯å…¥æ–‡å­—å½ˆçª— */}
          {showImportModal && (
            <div className="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col overflow-hidden animate-in fade-in zoom-in duration-200">
                <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                  <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><FileText className="w-5 h-5 text-blue-600" /> å¤§é‡åŒ¯å…¥ç°¡å ±æ–‡å­—</h2>
                  <button onClick={() => setShowImportModal(false)} className="text-slate-400 hover:text-slate-600 transition-colors p-1"><X className="w-6 h-6" /></button>
                </div>
                <div className="p-6 flex-1 flex flex-col">
                  <div className="text-sm text-slate-600 mb-4 bg-blue-50/50 p-4 rounded-xl border border-blue-100/50 leading-relaxed">
                    è«‹åœ¨ä¸‹æ–¹è²¼ä¸Šæ‚¨çš„ç°¡å ±å¤§ç¶±ã€‚æ¯å€‹å€å¡Šçš„ <strong>ç¬¬ä¸€è¡Œ</strong> å°‡æœƒæˆç‚ºæ¨™é¡Œï¼Œå…¶é¤˜ç‚ºå…§æ–‡ã€‚<br/>
                    è«‹ä½¿ç”¨ <code className="bg-white px-2 py-0.5 rounded shadow-sm text-blue-600 font-bold">---</code> å–®ç¨ä¸€è¡Œä¾†åˆ†éš”ä¸åŒçš„é é¢ã€‚
                  </div>
                  <textarea 
                    value={importText} 
                    onChange={(e) => setImportText(e.target.value)} 
                    placeholder={`ç¯„ä¾‹ï¼š\nç¬¬ä¸€å­£è²¡å‹™å ±å‘Š\nä¸»è¬›äººï¼šè²¡å‹™éƒ¨\n---\nç‡Ÿæ”¶æ¦‚æ³\n- Q1 ç¸½ç‡Ÿæ”¶é” 500 è¬\n- è¼ƒå»å¹´åŒæœŸæˆé•· 15%`} 
                    className="w-full h-64 border border-slate-200 rounded-xl p-4 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none resize-none font-mono custom-scrollbar bg-slate-50" 
                  />
                </div>
                <div className="p-4 border-t border-slate-100 flex justify-end gap-3 bg-slate-50">
                  <button onClick={() => setShowImportModal(false)} className="px-5 py-2 rounded-lg font-medium text-slate-600 hover:bg-slate-200 transition-colors">å–æ¶ˆ</button>
                  <button onClick={handleImport} className="px-5 py-2 rounded-lg font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors shadow-sm">ç¢ºèªåŒ¯å…¥ä¸¦å–ä»£</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
